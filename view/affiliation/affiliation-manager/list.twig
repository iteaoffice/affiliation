{% do headTitle().append(translate("txt-admin")) %}
{% do headTitle().append(translate("txt-affiliation-list")) %}

{% do form.prepare() %}
{{ form().openTag(form)|raw }}

<div class="row">
    <div class="col-md-10">

        <h1>{{ translate("txt-affiliation-list") }}</h1>

        <div class="row">
            <div class="col-md-6">
                <p class="lead">{{ translate("txt-affiliation-list-explanation") }}</p>
                <p><a href="{{ url('zfcadmin/affiliation/list-csv') }}{% if fullArguments %}?{{ fullArguments }}{% endif %}"
                      class="btn btn-primary">{{ translate("txt-download-as-csv") }}</a></p>
            </div>
            <div class="col-md-6">
                <p>
                <div class="input-group">
                    {{ formelement(form.get('query')) }}
                    <span class="input-group-btn">
                        {{ formelement(form.get('search')) }} {{ formelement(form.get('reset')) }}
                        </span>
                </div>
                </p>
                <p>
                <div class="form-inline">
                    <div class="form-group">{{ formelement(form.get('group')) }}</div>
                    {{ formelement(form.get('apply')) }}
                </div>
                </p>
                {% if paginator %}
                    <p class="text-muted">
                        {{ translate("txt-%s-items-on-%s-pages")|format(paginator.adapter.count, paginator.pageRange) }}
                    </p>
                {% elseif groups %}
                    <p class="text-muted">
                        {{ translate("txt-%s-items-in-%s-groups")|format(groups.getMatches(), groups.getNumberOfGroups()) }}
                    </p>
                {% endif %}
                <div class="row">
                    {{ ztbformelement(form.get('cols')) }}
                </div>
            </div>
        </div>
        {% if groups %}
            <hr>
            <table id="tbl-list" class="table table-striped table-condensed">
                <thead>
                <tr>
                    <th>{{ translate('txt-group') }}</th>
                    <th class="col-affiliation">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'organisation', 'text': translate('txt-affiliation')} %}</th>
                    <th class="col-effort-draft hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'effort_draft', 'text': translate('txt-effort-draft')} %}</th>
                    <th class="col-cost-draft hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'cost_draft', 'text': translate('txt-cost-draft')} %}</th>
                    <th class="col-effort-po hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'effort_po', 'text': translate('txt-effort-po')} %}</th>
                    <th class="col-cost-po hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'cost_po', 'text': translate('txt-cost-po')} %}</th>
                    <th class="col-latest-version">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'version_latest', 'text': translate('txt-lastest-version')} %}</th>
                    <th class="col-latest-effort">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'effort_latest', 'text': translate('txt-latest-version-effort')} %}</th>
                    <th class="col-latest-cost">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'cost_latest', 'text': translate('txt-latest-version-cost')} %}</th>
                    <th class="col-project">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'project', 'text': translate('txt-project')} %}</th>
                    <th class="col-call">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'call', 'text': translate('txt-call')} %}</th>
                    <th class="col-contact">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'contact', 'text': translate('txt-contact')} %}</th>
                </tr>
                </thead>
                <tbody>
                {% set effortLatestTotal, costLatestTotal, effortDraftTotal, costDraftTotal = 0, 0, 0, 0 %}
                {% set effortPoTotal, costPoTotal, effortFppTotal, costFppTotal = 0, 0, 0, 0 %}

                {% for valueGroup in groups %}

                    {% set effortLatestSum, costLatestSum, effortDraftSum, costDraftSum = 0, 0, 0, 0 %}
                    {% set effortPoSum, costPoSum, effortFppSum, costFppSum = 0, 0, 0, 0 %}

                    {% for result in valueGroup %}

                        {% set effortLatestSum = effortLatestSum+effortCount+result.fields.effort_latest %}
                        {% set costLatestSum = costLatestSum+result.fields.cost_latest %}
                        {% set effortDraftSum = effortDraftSum+result.fields.effort_draft %}
                        {% set costDraftSum = costDraftSum+result.fields.cost_draft %}
                        {% set effortPoSum = effortPoSum+result.fields.effort_po %}
                        {% set costPoSum = costPoSum+result.fields.cost_po %}
                        <tr>
                            <td>{{ valueGroup.getValue() }}</td>
                            <td class="col-affiliation">
                                <a href="{{ url('zfcadmin/affiliation/view',{'id':result.fields.affiliation_id }) }}">{{ result.fields.organisation }}</a>
                            </td>
                            <td class="col-effort-draft hidden">{{ result.fields.effort_draft|parse_effort }} {{ translate("txt-py") }}</td>
                            <td class="col-cost-draft hidden">{{ result.fields.cost_draft|parse_cost }} k&euro;</td>
                            <td class="col-effort-po hidden">{{ result.fields.effort_po|parse_effort }} {{ translate("txt-py") }}</td>
                            <td class="col-cost-po hidden">{{ result.fields.cost_po|parse_cost }} k&euro;</td>
                            <td class="col-latest-version">
                                {% if result.fields.project_latest_version_type|length > 0 %}
                                    <a href="{{ url('zfcadmin/project/version/view',{'id':result.fields.project_latest_version_id }) }}">{{ result.fields.project_latest_version_type }}</a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="col-latest-effort">{{ result.fields.effort_latest|parse_effort }} {{ translate("txt-py") }}</td>
                            <td class="col-latest-cost">{{ result.fields.cost_latest|parse_cost }} k&euro;</td>
                            <td class="col-project">
                                <a href="{{ url('zfcadmin/project/project/view',{'id':result.fields.project_id }) }}">{{ result.fields.project }}</a>
                            </td>
                            <td class="col-call">{{ result.fields.project_call }}</td>
                            <td class="col-contact">
                                <a href="{{ url('zfcadmin/contact-admin/view',{'id':result.fields.contact_id }) }}">{{ result.fields.contact }}</a>
                            </td>
                        </tr>
                    {% endfor %}
                    {% set effortLatestTotal, costLatestTotal = (effortLatestTotal+effortLatestSum), (costLatestTotal+costLatestSum) %}
                    {% set effortDraftTotal, costDraftTotal = (effortDraftTotal+effortDraftSum), (costDraftTotal+costDraftSum) %}
                    {% set effortPoTotal, costPoTotal = (effortPoTotal+effortPoSum), (costPoTotal+costPoSum) %}
                    <tr class="row-totals">
                        <th>{{ translate("txt-total") }}</th>
                        <th class="col-affiliation"></th>
                        <th class="col-effort-draft hidden">{{ effortDraftSum|parse_effort }} {{ translate("txt-py") }}</th>
                        <th class="col-cost-draft hidden">{{ costDraftSum|parse_cost }} k&euro;</th>
                        <th class="col-effort-po hidden">{{ effortPoSum|parse_effort }} {{ translate("txt-py") }}</th>
                        <th class="col-cost-po hidden">{{ costPoSum|parse_cost }} k&euro;</th>
                        <th class="col-latest-version"></th>
                        <th class="col-latest-effort">{{ effortLatestSum|parse_effort }} {{ translate("txt-py") }}</th>
                        <th class="col-latest-cost">{{ costLatestSum|parse_cost }} k&euro;</th>
                        <th class="col-project"></th>
                        <th class="col-call"></th>
                        <th class="col-contact"></th>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                <tr>
                    <th>{{ translate("txt-grand-total") }}</th>
                    <th class="col-affiliation"></th>
                    <th class="col-effort-draft hidden">{{ effortDraftTotal|parse_effort }} {{ translate("txt-py") }}</th>
                    <th class="col-cost-draft hidden">{{ costDraftTotal|parse_cost }} k&euro;</th>
                    <th class="col-effort-po hidden">{{ effortPoTotal|parse_effort }} {{ translate("txt-py") }}</th>
                    <th class="col-cost-po hidden">{{ costPoTotal|parse_cost }} k&euro;</th>
                    <th class="col-latest-version"></th>
                    <th class="col-latest-effort">{{ effortLatestTotal|parse_effort }} {{ translate("txt-py") }}</th>
                    <th class="col-latest-cost">{{ costLatestTotal|parse_cost }} k&euro;</th>
                    <th class="col-project"></th>
                    <th class="col-call"></th>
                    <th class="col-contact"></th>
                </tr>
                </tfoot>
            </table>

        {% elseif paginator and (paginator.pageRange > 0) %}
            <table id="tbl-list" class="table table-striped">
                <thead>
                <tr>
                    <th class="col-affiliation">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'organisation', 'text': translate('txt-affiliation')} %}</th>
                    <th class="col-effort-draft hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'effort_draft', 'text': translate('txt-effort-draft')} %}</th>
                    <th class="col-cost-draft hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'cost_draft', 'text': translate('txt-cost-draft')} %}</th>
                    <th class="col-effort-po hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'effort_draft', 'text': translate('txt-effort-po')} %}</th>
                    <th class="col-cost-po hidden">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'cost_draft', 'text': translate('txt-cost-po')} %}</th>
                    <th class="col-latest-version">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'version_latest', 'text': translate('txt-lastest-version')} %}</th>
                    <th class="col-latest-effort">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'effort_latest', 'text': translate('txt-latest-version-effort')} %}</th>
                    <th class="col-latest-cost">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'cost_latest', 'text': translate('txt-latest-version-cost')} %}</th>
                    <th class="col-project">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'project', 'text': translate('txt-project')} %}</th>
                    <th class="col-call">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'call', 'text': translate('txt-call')} %}</th>
                    <th class="col-contact">{% include 'affiliation/partial/sortable-table-header' with {'route': 'zfcadmin/affiliation/list', 'criteria': 'contact', 'text': translate('txt-contact')} %}</th>
                </tr>
                </thead>
                <tbody>
                {% for result in paginator.getCurrentItems() %}
                    {% set organisationService = organisationService.setOrganisationId(result.fields.organisation_id) %}
                    <tr>
                        <td class="col-affiliation">
                            <a href="{{ url('zfcadmin/affiliation/view',{'id':result.fields.affiliation_id }) }}">{{ organisationService.parseOrganisationWithBranch(result.fields.branch) }}</a>
                        </td>
                        <td class="col-effort-draft hidden">{{ result.fields.effort_draft|parse_effort }} {{ translate("txt-py") }}</td>
                        <td class="col-cost-draft hidden">{{ result.fields.cost_draft|parse_cost }} k&euro;</td>
                        <td class="col-effort-po hidden">{{ result.fields.effort_po|parse_effort }} {{ translate("txt-py") }}</td>
                        <td class="col-cost-po hidden">{{ result.fields.cost_po|parse_cost }} k&euro;</td>
                        <td class="col-latest-version">
                            {% if result.fields.project_latest_version_type|length > 0 %}
                                <a href="{{ url('zfcadmin/project/version/view',{'id':result.fields.project_latest_version_id }) }}">{{ result.fields.project_latest_version_type }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="col-latest-effort">{{ result.fields.effort_latest|parse_effort }} {{ translate("txt-py") }}</td>
                        <td class="col-latest-cost">{{ result.fields.cost_latest|parse_cost }} k&euro;</td>
                        <td class="col-project">
                            <a href="{{ url('zfcadmin/project/project/view',{'id':result.fields.project_id }) }}">{{ result.fields.project }}</a>
                        </td>
                        <td class="col-call">{{ result.fields.project_call }}</td>
                        <td class="col-contact">
                            <a href="{{ url('zfcadmin/contact-admin/view',{'id':result.fields.contact_id }) }}">{{ result.fields.contact }}</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                </tfoot>
            </table>

            {% include 'affiliation/partial/pagination-control' with {'paginator': paginator} %}
        {% else %}
            {{ ztbalert().info(translate("txt-no-affiliations-found"))|raw }}
        {% endif %}
    </div>
    <div class="col-md-2">
        <div class="well well-sm">
            {% set facets = form.get('facet') %}
            {% for facet in facets %}
                {{ ztbformelement(facet) }}
            {% endfor %}
        </div>
    </div>
</div>

{{ form().closeTag()|raw }}

<script type="text/javascript">
    $(function () {
        var facetCheckBoxes = $('div.well input[type="checkbox"]'),
                colCheckboxes = $('#control-group-cols');
        facetCheckBoxes.add('#searchButton, #resetButton').on('click', function () {
            if ($(this).is('#resetButton')) {
                facetCheckBoxes.each(function () {
                    this.removeAttribute('checked');
                });
                $('input[name="query"]').val('');
            }
            $('#search').submit();
        });
        colCheckboxes.find('input[type="checkbox"]').on('change', function () {
            var $self = $(this);
            $('#tbl-list .' + $self.attr('value')).toggleClass('hidden', !$self.is(':checked'));
        });
    });
</script>