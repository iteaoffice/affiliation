{% do headTitle().append(translate("txt-affiliation")) %}
{% do headTitle().append(translate("txt-%s-in-%s")|format(affiliation.organisation.organisation, affiliation.project.parseFullName())) %}

{% do headLink().appendStylesheet(url('assets/funding-status-css')) %}

{% set years = projectService.parseYearRange(affiliation.project, false, affiliation) %}
{% set projectYears = projectService.parseYearRange(affiliation.project, true) %}

{# Produce the link first to have the resource :) #}
{% set affiliationLink = affiliationLink(affiliation, 'edit-community','button') %}

<h1>{{ affiliation.organisation.organisation }}</h1>

<p class="lead">{{ translate("txt-partner-in-%s")|format(
    affiliation.project.parseFullName()
    ) }} {{ affiliationLink(affiliation,'view-admin','icon') }}</p>

{% if affiliation.dateEnd %}
    {{ ztbalert().danger(translate("txt-affiliation-%s-has-been-deactivated-on-%s-date"))|format(
    affiliation,
    affiliation.dateEnd|string_date
    )|raw }}
{% endif %}

<ul class="nav nav-tabs">
    <li class="active"><a href="#details" data-toggle="tab">{{ translate("txt-partner-details") }}</a></li>
    <li><a href="#description" data-toggle="tab">{{ translate("txt-description") }}</a></li>
    <li><a href="#cost-and-effort" data-toggle="tab">{{ translate("txt-cost-and-effort") }}</a></li>
    <li><a href="#contact" data-toggle="tab">{{ translate("txt-contacts") }}</a></li>
    {% if projectService.isLabelled(affiliation.project) %}
        <li><a href="#report" data-toggle="tab">{{ translate("txt-reporting") }}</a></li>
    {% endif %}
    {% if isAllowed(affiliation,'edit-affiliation') or isAllowed(affiliation,'edit-financial') %}
        <li><a href="#invoicing" data-toggle="tab">{{ translate("txt-invoicing") }}</a></li>
    {% endif %}
</ul>

<!-- Tab panes -->
<div class="tab-content">
    <div class="tab-pane active" id="details">
        <h3>{{ translate("txt-affiliation-information") }}</h3>

        <dl class="dl-horizontal">
            <dt>{{ translate("txt-project-name") }}</dt>
            <dd>{{ projectLink(affiliation.project,'view-community', 'name') }}</dd>
            <dt>{{ translate("txt-project-title") }}</dt>
            <dd>{{ affiliation.project.title }}</dd>
            <dt>{{ translate("txt-status") }}</dt>
            <dd>{{ projectService.parseStatus(affiliation.project) }}</dd>
            <dt>{{ translate("txt-project-leader") }}</dt>
            <dd>{{ affiliation.project.contact.displayName() }}
                ({{ affiliation.project.contact.contactOrganisation.organisation }}) <a
                        href="mailto:{{ affiliation.project.contact.email }}"><i class="fa fa-envelope-o"></i></a>
                {{ contactLink(affiliation.project.contact,'view-admin','icon') }}
            </dd>
            {#<dt>{{ translate("txt-call-name") }}</dt>#}
            {#<dd>{{ project.call }}</dd>#}
            <dt>{{ translate("txt-project-country") }}</dt>
            <dd>{{ affiliation.project.contact.contactOrganisation.organisation.country }}</dd>
        </dl>

        <dl class="dl-horizontal">
            <dt>{{ translate("txt-position-on-value-chain") }}</dt>
            <dd>{{ affiliation.valueChain|default('<i class="fa fa-exclamation-circle warning"></i>')|raw }}</dd>
            <dt>{{ translate("txt-main-contributions-and-added-value") }}</dt>
            <dd>{{ affiliation.mainContribution|default('<i class="fa fa-exclamation-circle warning"></i>')|raw }}</dd>
            <dt>{{ translate("txt-strategic-importance") }}</dt>
            <dd>{{ affiliation.strategicImportance|default('<i class="fa fa-exclamation-circle warning"></i>')|raw }}</dd>
            <dt>{{ translate("txt-market-access") }}</dt>
            <dd>{{ affiliation.marketAccess|default('<i class="fa fa-exclamation-circle warning"></i>')|raw }}</dd>

        </dl>

        <dl class="dl-horizontal">
            <dt>{{ translate("txt-funding-status") }}</dt>
            {% for year in projectService.parseYearRange(affiliation.project) %}
                <dd> {{ year }}:
                    {% if affiliationService.isSelfFunded(affiliation) %}
                        {{ translate("txt-self-funded") }}
                    {% elseif (affiliationService.getFundingInYear(affiliation,year)) %}
                        <span class="badge funding-status {{ affiliationService.getFundingInYear(affiliation,year).status.parseCssName }}">{{ affiliationService.getFundingInYear(affiliation,year).status.statusFunding }}</span>
                    {% else %}
                        {{ translate("txt-not-set") }}
                    {% endif %}
                </dd>
            {% endfor %}
        </dl>

        <dl class="dl-horizontal">

            {% if (requirePartnership) %}
                <dt>{{ translate("txt-partnership") }}</dt>
                <dd>
                    {% if affiliation.organisation.partner %}
                        {#{{ partnerLink(affiliation.organisation.partner,'view','name') }}#}
                        {{ translate("txt-organsation-%s-is-partner-type-%s-since-%s")|format(affiliation.organisation,affiliation.organisation.partner.type,affiliation.organisation.partner.dateCreated|time_diff) }}
                    {% elseif (affiliation.organisation.applicant) %}
                        {{ applicantLink(affiliation.organisation.applicant,'view','text') }}
                    {% else %}
                        {{ applicantLink(null,'apply','text', null, null, null, affiliation.organisation) }}
                    {% endif %}
                </dd>
            {% endif %}

            {% if affiliation.project.call.doaRequirement is constant('\\Program\\Entity\\Call\\Call::DOA_REQUIREMENT_PER_PROGRAM') %}
                <dt>{{ translate("txt-program-declaration-of-acceptance") }}</dt>
                <dd>{% for programDoa in affiliation.organisation.programDoa if programDoa.program.id == project.call.program.id %}
                        {% if programDoa.dateApproved is null %}
                            {{ translate("txt-doa-received-on-%s-but-waiting-for-approval")|format(programDoa.dateCreated|date("d-m-Y"))|raw }}
                            {{ programDoaLink(programDoa,'replace','icon') }}
                            {{ programDoaLink(programDoa,'download','icon') }}
                        {% else %}
                            {{ translate("txt-doa-received-and-approved-on-%s")|format(programDoa.dateApproved|date("d-m-Y"))|raw }}
                            {{ programDoaLink(programDoa,'download','icon') }}
                        {% endif %}
                    {% else %}
                        {{ programDoaLink(null,'upload','text', affiliation.organisation, project.call.program) }}
                    {% endfor %}
                </dd>
            {% endif %}

            {% if affiliation.project.call.doaRequirement is constant('\\Program\\Entity\\Call\\Call::DOA_REQUIREMENT_PER_PROJECT') %}
                <dt>{{ translate("txt-project-declaration-of-acceptance") }}</dt>
                <dd>
                    {% if not affiliationService.hasDoa(affiliation) %}
                        {{ doaLink(null,'upload','text', affiliation) }}
                    {% elseif affiliation.doa.dateApproved is null %}
                        {{ translate("txt-doa-received-on-%s-but-waiting-for-approval")|
                        format(affiliation.doa.getDateCreated()|date("d-m-Y"))|raw }}
                        {{ doaLink(affiliation.doa,'replace','icon') }}
                        {{ doaLink(affiliation.doa,'download','icon') }}
                    {% else %}
                        {{ translate("txt-doa-received-and-approved-on-%s")|format(affiliation.doa.dateApproved|string_date)|raw }}
                        {{ doaLink(affiliation.doa,'download','icon') }}
                    {% endif %}
                </dd>
            {% endif %}

            <dt>{{ translate("txt-letter-of-intent") }}</dt>
            <dd>
                {% if not affiliationService.hasLoi(affiliation) %}
                    {{ loiLink(null,'upload','text', affiliation) }}
                {% elseif affiliation.loi.dateApproved is null %}
                    {{ translate("txt-loi-received-on-%s-but-waiting-for-approval")|
                    format(affiliation.loi.getDateCreated()|date("d-m-Y"))|raw }}
                    {{ loiLink(affiliation.loi,'replace','icon') }}
                    {{ loiLink(affiliation.loi,'download','icon') }}
                {% else %}
                    {{ translate("txt-loi-received-and-approved-on-%s")|format(affiliation.loi.dateApproved|string_date) }}
                    {{ loiLink(affiliation.loi,'download','icon') }}
                {% endif %}
            </dd>
            <dt>{{ translate("txt-technical-contact") }}</dt>
            <dd>{{ affiliation.contact.displayName() }}
                <a href="mailto:{{ affiliation.contact.email }}"><i class="fa fa-envelope-o"></i></a>
                {{ contactLink(affiliation.contact,'view-admin','icon') }}
            </dd>
            {% if affiliation.financial %}
                <dt>{{ translate("txt-financial-contact") }}</dt>
                <dd>
                    {{ affiliation.financial.contact.displayName }} <a
                            href="mailto:{{ affiliation.financial.contact.email }}"><i
                                class="fa fa-envelope-o"></i></a>
                    {{ contactLink(affiliation.contact,'view-admin','icon') }}
                </dd>
            {% endif %}
        </dl>

        {{ affiliationLink|raw }}
    </div>
    <div class="tab-pane" id="description">
        <h3>{{ translate("txt-partner-description") }}</h3>

        {% for description in affiliation.description %}
            <dl class="dl-horizontal">
                <dt>{{ translate("txt-description") }}</dt>
                <dd>{{ description.description|raw|nl2br }}</dd>
            </dl>
        {% else %}
            {{ ztbalert().warning(translate("txt-no-description-found-for-%s")|format(
            affiliation.organisation.organisation
            ))|raw }}
        {% endfor %}

        {{ affiliationLink(affiliation, 'edit-description','button') }}
    </div>
    <div class="tab-pane" id="cost-and-effort">

        {% if latestVersion %}

            {# README todo
                Currently we take the draft-cost and effort based year distrubion to see the effect of that.
                Later we can take here the project duraction pased year distribution
            #}
            <h3>{{ translate("txt-latest-%s-version-of-type-%s")|format(versionService.parseStatus(latestVersion)|lower, latestVersion.versionType) }}</h3>

            <p>{{ translate("txt-latest-submitted-version-of-type-%s-explanation")|format(latestVersion.versionType) }}</p>

            <table class="table table-hover table-striped table-condensed">
                <thead>
                <tr>
                    <th colspan="2">{{ translate("txt-cost-and-effort") }}</th>
                    {% for year in years %}
                        <th>{% if year in projectYears %}{{ year }}{% else %}<span
                                class="warning"
                                title="{{ translate("txt-the-project-is-not-active-in-this-year") }}">{{ year }}</span>{% endif %}
                            [k&euro;]
                        </th>
                    {% endfor %}
                    <th>{{ translate("txt-total-costs") }} [k&euro;]</th>
                </tr>
                </thead>
                <tbody>
                {% set costPerYear = versionService.findTotalCostVersionByAffiliationAndVersionPerYear(
                affiliation,
                latestVersion
                ) %}
                {% set totalPerYear = 0 %}
                <tr>
                    <td colspan="2">{{ translate("txt-costs") }}</td>
                    {% for year in years %}
                        <td class="cost_version_value"
                            rel="cost_version_{{ year }}">{{ costPerYear[year]|parse_cost_edit }}</td>
                        {% set totalPerYear = totalPerYear + costPerYear[year] %}
                    {% endfor %}
                    <th id="cost_version_total">{{ totalPerYear|parse_cost_edit }}</th>
                </tr>
                </tbody>
                <thead>
                <tr>
                    <th>{{ translate("txt-workpackage-number") }}</th>
                    <th>{{ translate("txt-workpackage-name") }}</th>
                    {% for year in years %}
                        <th>{% if year in projectYears %}{{ year }}{% else %}<span
                                class="warning"
                                title="{{ translate("txt-the-project-is-not-active-in-this-year") }}">{{ year }}</span>{% endif %}
                            [{{ translate("txt-py") }}]
                        </th>
                    {% endfor %}
                    <th>{{ translate("txt-total-effort") }}</th>
                </tr>
                </thead>
                <tbody>
                {% for workpackage in workpackageService.findWorkpackageByProjectAndWhich(affiliation.project) %}
                    {% set effortPerYear = versionService.findTotalEffortVersionByWorkpackageAndAffiliationAndVersionPerYear(
                    workpackage,
                    affiliation,
                    latestVersion,
                    'object'
                    ) %}
                    {% set totalPerWP = 0 %}
                    <tr>
                        <td>{{ workpackageLink(workpackage,'view-community', 'sequence') }}</td>
                        <td>{{ workpackageLink(workpackage,'view-community', 'name') }}</td>
                        {% for year in years %}
                            <td class="effort_version_value"
                                rel="effort_version_{{ affiliation.id }}_{{ workpackage.id }}_{{ year }}">{{ effortPerYear[year].effort|default(0)|parse_effort }}</td>
                            {% set totalPerWP = totalPerWP + effortPerYear[year].effort %}
                        {% endfor %}
                        <th id="effort_version_total_{{ workpackage.id }}">{{ totalPerWP|parse_effort }}</th>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            <hr>
        {% endif %}

        {% if projectService.isPrepareMode(affiliation.project) %}
            <h3>{{ translate("txt-latest-unsubmitted-version") }}</h3>

            {{ ztbalert().info(translate("txt-explanation-cost-and-effort-edit-in-place"))|raw }}

            <table class="table table-hover table-striped table-condensed">
                <thead>
                <tr>
                    <th colspan="2">{{ translate("txt-cost-and-effort") }}</th>
                    {% for year in years %}
                        <th>{% if year in projectYears %}{{ year }}{% else %}<span
                                class="warning"
                                title="{{ translate("txt-the-project-is-not-active-in-this-year") }}">{{ year }}</span>{% endif %}
                            [k&euro;]
                        </th>
                    {% endfor %}
                    <th>{{ translate("txt-total-costs") }} [k&euro;]</th>
                </tr>
                </thead>
                <tbody>
                {% set costPerYear = projectService.findTotalCostByAffiliationPerYear(affiliation) %}

                {# do a second iteration over the previous version to highlight the difference#}
                {% if latestVersion %}
                    {% set costPerYearInVersion = versionService.findTotalCostVersionByAffiliationAndVersionPerYear(
                    affiliation,
                    latestVersion
                    ) %}
                {% endif %}


                {% set totalPerYear = 0 %}
                <tr class="cost_row">
                    <td colspan="2">{{ translate("txt-costs") }}</td>
                    {% for year in years %}
                        <td>
                            {% if
                            year in projectService.parseEditYearRange(affiliation.project) and
                            (
                            hasProjectEditRights or
                            isAllowed(affiliation, 'edit-affiliation')
                            ) %}
                                <i class="fa pull-left"></i>
                                <a id="cost_{{ year }}"
                                   href="#" class="affiliation workpackage" data-type="text"
                                   data-pk="{{ affiliation.id }},{{ year }}"
                                   data-url="{{ url('json/update-cost') }}"
                                   data-title="{{ translate("txt-update-costs") }}">{{ costPerYear[year]|parse_cost_edit }}</a>
                            {% else %}
                                <i class="fa pull-left"></i>
                                <span id="cost_{{ year }}"
                                      class="workpackage"
                                      rel="{{ year }}">{{ costPerYear[year]|parse_cost_edit }}</span>
                            {% endif %}
                        </td>
                        {% set totalPerYear = totalPerYear + costPerYear[year] %}
                    {% endfor %}
                    <th class="cost_total"><i class="fa pull-left"></i><span>{{ totalPerYear|parse_cost_edit }}</span>
                </tr>
                </tbody>
                <thead>
                <tr>
                    <th>{{ translate("txt-workpackage-number") }}</th>
                    <th>{{ translate("txt-workpackage-name") }}</th>
                    {% for year in years %}
                        <th>{% if year in projectYears %}{{ year }}{% else %}<span
                                class="warning"
                                title="{{ translate("txt-the-project-is-not-active-in-this-year") }}">{{ year }}</span>{% endif %}
                            [{{ translate("txt-py") }}]
                        </th>
                    {% endfor %}
                    <th>{{ translate("txt-total-effort") }}</th>
                </tr>
                </thead>
                <tbody>
                {% for workpackage in workpackageService.findWorkpackageByProjectAndWhich(affiliation.project) %}
                    {% set effortPerYear = projectService.findTotalEffortByWorkpackageAndAffiliationPerYear(
                    workpackage,
                    affiliation,
                    'object') %}
                    {% set totalPerWP = 0 %}

                    {# do a second iteration over the previous version to highlight the difference#}
                    {% if latestVersion %}
                        {% set effortPerYearInVersion =
                        versionService.findTotalEffortVersionByWorkpackageAndAffiliationAndVersionPerYear(
                        workpackage,
                        affiliation,
                        latestVersion
                        ) %}
                    {% endif %}


                    <tr class="workpackage_row" rel="{{ workpackage.id }}">
                        <td>{{ workpackageLink(workpackage,'view-community', 'sequence') }}</td>
                        <td>{{ workpackageLink(workpackage,'view-community', 'name') }}</td>
                        {% for year in years %}
                        {% set effortInCurrentYear = effortPerYear[year].effort %}

                        <td>
                            {% if
                            year in projectService.parseEditYearRange(affiliation.project) and
                            (
                            hasProjectEditRights or
                            isAllowed(workpackage, 'edit-community') or
                            isAllowed(affiliation, 'edit-affiliation')
                            ) %}
                                <i class="fa pull-left"></i>
                                <a id="effort_{{ affiliation.id }}_{{ workpackage.id }}_{{ year }}"
                                   href="#" class="affiliation workpackage" data-type="text"
                                   data-pk="{{ affiliation.id }},{{ workpackage.id }},{{ year }}"
                                   data-url="{{ url('json/update-effort') }}"
                                   data-title="{{ translate("txt-update-effort") }}">{{ effortInCurrentYear|parse_effort }}</a>
                            {% else %}
                                <i class="fa pull-left"></i>
                                <span id="effort_{{ affiliation.id }}_{{ workpackage.id }}_{{ year }}"
                                      class="workpackage"
                                      rel="{{ year }}">{{ effortInCurrentYear|parse_effort }}</span>
                            {% endif %}
                            {% set totalPerWP = totalPerWP + effortInCurrentYear %}
                            {% endfor %}
                        <th class="effort_total"><i class="fa pull-left"></i><span>{{ totalPerWP|parse_effort }}</span>
                        </th>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            {{ projectLink(affiliation.project, 'edit-cost-and-effort-community', 'button') }}
        {% endif %}

    </div>
    <div class="tab-pane" id="contact">

        <h3>{{ translate("txt-associate-details") }}</h3>

        {% if contactsInAffiliation.contacts|length > 0 %}
            <table class="table table-striped table-hover table-condensed">
                <thead>
                <tr>
                    <th>{{ translate("txt-associate-name") }}</th>
                    <th>{{ translate("txt-roles") }}</th>
                </tr>
                </thead>
                <tbody>
                {% for contact in contactsInAffiliation.contacts %}
                    <tr>
                        <td>{{ contact.displayName }} <a
                                    href="mailto:{{ contact.email }}"><i class="fa fa-envelope-o"></i></a></td>
                        <td>
                            {{ contactsInAffiliation['contactRole'][contact.id]|join(', ') }}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            {{ ztbalert().info(translate("txt-no-associates-in-this-affiliation"))|raw }}
        {% endif %}

        {{ affiliationLink(affiliation,'add-associate','button') }}
    </div>

    {% if projectService.isLabelled(affiliation.project) %}
        <div class="tab-pane" id="report">

            <h4>{{ translate("txt-progress-report-information") }}</h4>

            {% if affiliation.project.report.count() > 0 %}
                <table class="table table table-hover table-striped">
                    <thead>
                    <tr>
                        <th class="col-md-3">{{ translate("txt-report") }}</th>
                        <th class="col-md-2">{{ translate("txt-contact") }}</th>
                        <th>{{ translate("txt-effort-planned") }}</th>
                        <th>{{ translate("txt-effort-spent") }}</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for report in affiliation.project.report %}

                        {% set effortSpent = reportService.findEffortSpentByReportAndAffiliation(report, affiliation) %}

                        {% if latestVersion %}
                            {% set totalPlannedEffort = versionService.findTotalEffortByAffiliationAndVersionUpToReportingPeriod(
                            affiliation,
                            latestVersion,
                            report) %}
                        {% endif %}

                        <tr {% if report.dateFinal %}class="success"{% endif %}>
                            <td>{{ report.parseName() }}</td>
                            <td>{{ report.contact.displayName }}</td>
                            <td>{{ totalPlannedEffort|parse_effort }} [{{ translate("txt-py") }}]</td>
                            {% if effortSpent %}
                                <td {% if effortSpent.comment|length > 0 %}title="{{ effortSpent.comment }}{% endif %}">{{ effortSpent.effort|parse_effort }}
                                    [{{ translate("txt-py") }}]
                                </td>
                                <td>
                                    {% if not report.dateFinal %}{{ affiliationEffortSpentLink(affiliation, 'update-effort-spent', 'update', report) }}{% endif %}</td>
                            {% else %}
                                <td></td>
                                <td>{% if not report.dateFinal %}{{ affiliationEffortSpentLink(affiliation, 'update-effort-spent', 'button', report) }}{% endif %}</td>
                            {% endif %}
                        </tr>
                        {% if effortSpent %}
                            <tr>
                                <td></td>
                                <td colspan="4"><strong>{{ translate("txt-summary") }}
                                        : </strong>{{ effortSpent.summary|nl2br|default(translate("txt-not-provided")) }}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <br>
                {{ ztbalert().info(translate("txt-no-effort-spent-has-been-provided-for-%s")|format(affiliation.project.parseFullname()))|raw }}
            {% endif %}

            <h4>{{ translate("txt-exploitation-related-achievement") }}</h4>

            {% if affiliation.achievement.count > 0 %}
                <table class="table table-hover table-striped table-condensed">
                    <thead>
                    <tr>
                        <th>{{ translate("txt-achievement") }}</th>
                        <th>{{ translate("txt-date") }}</th>
                        <th>{{ translate("txt-status") }}</th>
                        <th>{{ translate("txt-category") }}</th>
                        <th>{{ translate("txt-type") }}</th>
                        <th>{{ translate("txt-contact") }}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for achievement in affiliation.achievement %}
                        <tr>
                            <td>
                                {{ achievementLink(achievement,'view-community', 'name') }}
                            </td>
                            <td>{{ achievement.dateCreated|string_date }} {% if latestReviewMeeting and latestReviewMeeting.dateEnd < result.dateCreated %}
                                    <span class="label label-primary">{{ translate("txt-new") }}</span>{% endif %}</td>
                            <td>{{ translate(achievement.getStatus(true)) }}</td>
                            <td>{{ achievement.type.category }}</td>
                            <td>{{ achievement.type }}</td>
                            <td>{{ achievement.contact.displayName }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>

            {% else %}
                <br>
                {{ ztbalert().info(translate("txt-no-exploitation-related-achievements-were-created-for-%s")|format(affiliation.project.parseFullName()))|raw }}
            {% endif %}

            {{ achievementLink(null, 'create', 'button', affiliation) }}


        </div>
    {% endif %}


    {% if isAllowed(affiliation,'edit-affiliation') or isAllowed(affiliation,'edit-financial') %}
        <br>
        <div class="tab-pane" id="invoicing">

            <tabset type="pills">
                <tab heading="{{ translate("txt-invoicing-details") }}">

                    <h3>{{ translate("txt-invoicing-details") }}</h3>

                    {% if affiliation.financial %}
                        <dl class="dl-horizontal">
                            <dt>{{ translate("txt-address-label") }}</dt>
                            <dd>{{ organisationService.parseOrganisationWithBranch(affiliation.financial.branch, affiliation.financial.organisation) }}</dd>


                            {% if contact.department %}
                                <dd>{{ contact.department }}</dd>
                            {% endif %}

                            {% set financialAddress = contactService.getFinancialAddress(affiliation.financial.contact) %}
                            <dd>{{ financialAddress }}</dd>
                            <dd>{{ financialAddress.zipcode }} {{ financialAddress.city }}</dd>
                            <dd>{{ financialAddress.country|upper }}</dd>
                        </dl>

                    {% else %}
                        {{ ztbalert().danger(translate("txt-we-have-no-financial-information-for-this-partner-%s")|format(affiliation))|raw }}
                    {% endif %}


                    {% if organisation.financial %}
                        <dl class="dl-horizontal">
                            <dt>{{ translate('txt-vat-number') }}</dt>
                            <dd>{{ organisation.financial.vat }}</dd>

                            {% if organisation.financial.omitContact == constant("Organisation\\Entity\\Financial::NO_OMIT_CONTACT") %}
                                <dd>{{ contactService.parseAttention(organisation.financial.contact) }} {{ organisation.financial.contact.parseFullName() }}</dd>
                            {% endif %}


                            <dt>{{ translate("txt-preferred-delivery") }}</dt>
                            {% if organisation.financial.email == constant("Organisation\\Entity\\Financial::EMAIL_DELIVERY") %}
                                <dd>{{ translate("txt-by-email-to-%s")|format(contact.email) }}</dd>
                            {% else %}
                                <dd>{{ translate("txt-by-postal-mail") }}</dd>
                            {% endif %}
                        </dl>
                    {% else %}
                        {{ ztbalert().danger(translate("txt-we-have-no-financial-information-for-the-organisation-%s")|format(affiliation.organisation))|raw }}
                    {% endif %}

                    {{ affiliationLink(affiliation, 'edit-financial','button') }}
                </tab>
                {% if isAllowed(affiliation,'payment-sheet-admin') %}
                    <tab heading="{{ translate("txt-payment-sheet") }}">


                        {% set year =  "now"|date("Y") %}
                        {% set period = ("now"|date("n") <= 6) ? 1 : 2 %}

                        <h3>{{ translate("txt-payment-sheet-year-%s-period-%s")|format(year, period) }} {{ affiliationLink(affiliation,'payment-sheet-pdf','icon', year, period) }}</h3>

                        {{ paymentSheet(affiliation, year, period) }}

                    </tab>

                    <tab heading="{{ translate("txt-invoices") }}">

                        <h3>{{ translate("txt-partner-invoices") }}</h3>

                        <table class="table table-hover table-striped table-condensed">
                            <thead>
                            <tr>
                                <th>{{ translate("txt-invoice-number") }}</th>
                                <th>{{ translate("txt-invoice-date") }}</th>
                                <th>{{ translate("txt-period") }}</th>
                                <th>{{ translate("txt-amount") }}</th>
                                <th>{{ translate("txt-status") }}</th>
                                <th>{{ translate("txt-download") }}</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for affilaitionInvoice in affiliation.invoice %}
                                {% if invoiceService.isSent(affilaitionInvoice.invoice) %}
                                    <tr>
                                        <td>{{ affilaitionInvoice.invoice.invoiceNr }}</td>
                                        <td>{{ affilaitionInvoice.invoice.dateInvoice|date("d-m-Y") }}</td>
                                        <td>{{ affilaitionInvoice.year }}-{{ affilaitionInvoice.period }}</td>
                                        <td>{{ invoiceService.parseTotal(affilaitionInvoice.invoice)|localizedcurrency("EUR") }}</td>
                                        <td>{{ invoiceService.parseStatus(affilaitionInvoice.invoice)['name'] }}</td>
                                        <td>{{ invoiceLink(affilaitionInvoice.invoice,'download','icon') }}</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </tab>
                {% endif %}
            </tabset>
        </div>
    {% endif %}
</div>


<script type="text/javascript">
    $(document).on("ajaxComplete", function () {
        $(document).updateEffort();
        $(document).updateCost();
    });

    /**
     * Calculate the sum per year
     */
    $(document).ready(function () {
        $(document).updateEffort();
        $(document).updateCost();
        //turn to inline mode
        $.fn.editable.defaults.mode = 'popup';
        $('.affiliation').editable();
    });
</script>
